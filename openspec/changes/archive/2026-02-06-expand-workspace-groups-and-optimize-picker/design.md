## Context

当前工作区实现已经支持 include 视图、成员管理和右键批量加入，但多处逻辑仍假设“仅 3 个工作区”：设置初始化会 `slice(0,3)`、管理弹窗与右键菜单只遍历前 3 组、迁移逻辑也会截断到 3 组。这使得“更多工作区”无法真正落地。

UI 上，文件浏览器工具栏是左右两组按钮，空间有限。用户希望保留 3 个快捷按钮的熟悉布局，同时可通过右侧 `…` 访问全部工作区并按最近使用重排。

性能上，`WorkspaceMemberPickerModal` 在过滤文本变化、折叠开关时会 `render()` 并递归重建节点，导致大 Vault 场景卡顿。虽然已有单节点折叠和批量清空选择，但缺少“全部折叠/展开”与输入节流。

## Goals / Non-Goals

**Goals:**
- 支持用户配置和持久化多个工作区组（兼容旧版 3 组配置）。
- 工具栏保持 3 个快捷位，超出部分通过右侧 `…` 入口访问。
- 选择工作区后按“最新在前”更新展示顺序，并反映到快捷位。
- 设置、管理弹窗、右键菜单全部支持全量工作区，不再硬编码前 3。
- 优化工作区树选择器：减少重复构建，增加批量折叠/展开，保留已选状态。

**Non-Goals:**
- 不改动工作区 include 过滤语义（文件可见性规则保持不变）。
- 不引入复杂拖拽排序库或虚拟滚动依赖。
- 不重构整个文件浏览器工具栏框架。

## Decisions

- **数据模型从“索引驱动”升级为“ID 驱动”**：
  - `workspaceFocus.groups` 中每个工作区增加稳定 `id`。
  - 激活状态改为 `activeGroupId`（保留读取旧 `activeIndex` 的迁移）。
  - 这样在重排后不会出现“激活指向错位”。

- **排序策略采用“最近使用前置 + 手动重排基线”**：
  - 用户在设置中可以手动重排基础顺序。
  - 运行时每次激活会将该工作区前置，形成“最新在前”的展示顺序。
  - 工具栏 3 个快捷位与 `…` 弹出列表使用同一展示顺序，避免认知分裂。

- **工具栏入口采用“3 快捷 + 1 溢出”**：
  - 始终优先渲染前 3 个工作区为按钮（维持原有认知）。
  - 当总数 > 3 时，在最右增加 `…` 按钮；点击后展示全部工作区列表并可直接激活。
  - 按钮维持现有样式体系，补齐 `aria-label`、focus visible 和 hover 反馈。

- **全链路去除 `slice(0,3)` 限制**：
  - 设置页、管理弹窗、右键菜单均遍历全部工作区。
  - 仅工具栏“快捷可见数”限制为 3；能力层面不限制总数。

- **树选择器性能采用“缓存树模型 + 输入节流 + 批量折叠控制”**：
  - 模态打开时构建一次树模型并缓存路径小写索引。
  - 过滤输入使用短延迟 debounce，合并连续键入触发。
  - 折叠/展开操作在缓存树上执行，避免反复从 vault 深递归构建。
  - 新增“Collapse all / Expand all”，并保持 `selectedPaths` 在过滤与折叠切换中不丢失。

## Risks / Trade-offs

- [迁移复杂度提高] `activeIndex` 到 `activeGroupId` 迁移可能出现历史脏数据 → 启动时做健壮回退：无效 ID 时清空激活态。
- [最近使用排序可能打乱用户预期] 自动前置会改变顺序 → 提供设置内显式重排入口，且“最近前置”仅影响展示顺序，不改成员内容。
- [工作区数量过多导致菜单冗长] 溢出列表可能变长 → 在溢出弹层中保留紧凑行高并支持滚动。
- [性能优化引入状态同步复杂性] 缓存树与 UI 状态可能不一致 → 统一以路径 Set 为单一状态源，渲染仅做投影。

## Migration Plan

1. 加载设置时，为无 `id` 的历史工作区生成稳定 ID，并将旧 `activeIndex` 映射到 `activeGroupId`。
2. 保留旧字段读取兼容一版；保存时写入新结构。
3. 若迁移失败或指向不存在组，回退为 `activeGroupId = null`，确保文件浏览器可用。
4. 对旧版仅 3 组配置不做破坏性修改，升级后即成为“多组模型”的前 3 组。

## Open Questions

- `…` 入口使用 `Menu` 还是轻量 `Modal`：当前优先 `Menu`（实现小、与右键交互一致）；若后续需要搜索再升级为 `Modal`。
